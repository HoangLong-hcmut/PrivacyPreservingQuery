import pytest
import numpy as np
from datetime import date
from src.main import execute_secure_query
from src.pipeline.sanitizer import SecurityException
from src.pipeline.privacy_guard import PrivacyViolationException
from src.pipeline.budget import BudgetExhaustedException

def test_simulate_singling_out(budget_tracker):
    """
    Test that queries targeting small cohorts are blocked.
    """
    # We use a query that we know returns 0 or very few results in the real DB.
    # In the seeded DB, we don't have a patient with this specific address.
    # So the count will be 0.
    # 0 < MIN_COHORT_SIZE (10), so it should be blocked.
    
    user_id = "attacker_singling"
    query = "SELECT COUNT(*) FROM patients WHERE dob='1924-01-01' AND address='12345 Unique St'"
    epsilon = 0.1
    
    with pytest.MonkeyPatch.context() as m:
        m.setattr("src.main.budget_tracker", budget_tracker)
        
        with pytest.raises(PrivacyViolationException):
            execute_secure_query(query, user_id, epsilon)

def test_simulate_averaging_attack(budget_tracker):
    """
    Test that repeating queries exhausts the budget.
    """
    user_id = "attacker_averaging"
    query = "SELECT COUNT(*) FROM patients WHERE dob < '2000-01-01'"
    epsilon = 1.0
    budget_tracker.EPSILON_TOTAL = 10.0
    
    with pytest.MonkeyPatch.context() as m:
        m.setattr("src.main.budget_tracker", budget_tracker)
        
        # Can run 10 times
        for _ in range(10):
            execute_secure_query(query, user_id, epsilon)
            
        # 11th time should fail
        with pytest.raises(BudgetExhaustedException):
            execute_secure_query(query, user_id, epsilon)

def test_simulate_sql_injection(budget_tracker):
    """
    Test that malicious SQL is blocked by the sanitizer.
    """
    user_id = "attacker_sql"
    query = "SELECT * FROM patients; DROP TABLE patients;"
    epsilon = 1.0
    
    with pytest.MonkeyPatch.context() as m:
        m.setattr("src.main.budget_tracker", budget_tracker)
        
        with pytest.raises(SecurityException):
            execute_secure_query(query, user_id, epsilon)
