import pytest
from src.main import execute_secure_query
from src.pipeline.sanitizer import SecurityException
from src.pipeline.privacy_guard import PrivacyViolationException
from src.pipeline.budget import BudgetExhaustedException
from src.db_connector import execute_query

# IDs from seed
DOCTOR_ID = '001080000001'
RESEARCHER_ID = '001075000003'
ATTACKER_ID = '001092000007'

def test_simulate_singling_out(budget_tracker):
    """
    Test that queries targeting cohorts smaller than the safe threshold (k=5) are blocked.
    """
    user_id = DOCTOR_ID
    # Target a demographic likely to yield few or zero results
    query = "SELECT COUNT(*) FROM patients WHERE dob='1980-01-15' AND gender='M'"
    epsilon = 0.1
    
    # Ensure sufficient budget
    execute_query("UPDATE staff SET privacy_budget = 10.0 WHERE national_id=%s", (user_id,))

    with pytest.MonkeyPatch.context() as m:
        m.setattr("src.main.budget_tracker", budget_tracker)
        
        with pytest.raises(PrivacyViolationException):
            execute_secure_query(query, user_id, epsilon)

def test_simulate_averaging_attack(budget_tracker):
    """
    Test that repeated queries deplete the privacy budget, eventually resulting in a denial.
    """
    user_id = RESEARCHER_ID
    query = "SELECT COUNT(*) FROM patients WHERE dob < '2000-01-01'"
    epsilon = 1.0
    
    # Initialize budget to allow exactly 9 queries
    execute_query("UPDATE staff SET privacy_budget = 9.5 WHERE national_id=%s", (user_id,))
    
    with pytest.MonkeyPatch.context() as m:
        m.setattr("src.main.budget_tracker", budget_tracker)
        
        # Execute 9 successful queries
        for _ in range(9):
             execute_secure_query(query, user_id, epsilon)
             
        # 10th fails
        with pytest.raises(BudgetExhaustedException):
            execute_secure_query(query, user_id, epsilon)
            
        # 11th time should fail
        with pytest.raises(BudgetExhaustedException):
            execute_secure_query(query, user_id, epsilon)

def test_simulate_sql_injection(budget_tracker):
    """
    Test that malicious SQL is blocked by the sanitizer.
    """
    user_id = ATTACKER_ID
    query = "SELECT * FROM patients; DROP TABLE patients;"
    epsilon = 1.0
    
    with pytest.MonkeyPatch.context() as m:
        m.setattr("src.main.budget_tracker", budget_tracker)
        
        with pytest.raises(SecurityException):
            execute_secure_query(query, user_id, epsilon)

def test_simulate_tautology_injection(budget_tracker):
    """
    Test that tautology attacks (always true statements) are blocked.
    """
    user_id = DOCTOR_ID
    # Tautology attack to bypass filters or extract all rows
    query = "SELECT COUNT(*) FROM patients WHERE gender = 'M' OR 1=1"
    epsilon = 1.0
    
    with pytest.MonkeyPatch.context() as m:
        m.setattr("src.main.budget_tracker", budget_tracker)
        
        # Expecting the sanitizer to catch this malicious logic
        with pytest.raises(SecurityException):
             execute_secure_query(query, user_id, epsilon)

